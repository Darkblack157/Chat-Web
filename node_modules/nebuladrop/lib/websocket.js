const WebSocket = require('ws');
const EventEmitter = require('events');

class NebulaWebSocket extends EventEmitter {
    constructor() {
        super();
        this.clients = [];
    }

    start(port = 8080) {
        const wss = new WebSocket.Server({ port });
        wss.on('connection', (ws) => {
            this.clients.push(ws);
            ws.on('message', (msg) => {
                const data = JSON.parse(msg);
                this.emit('message', data, ws);
            });
            ws.on('close', () => {
                this.clients = this.clients.filter(c => c !== ws);
            });
        });
        console.log(`[WS] WebSocket iniciado na porta ${port}`);
    }

    broadcast(msg) {
        const data = JSON.stringify(msg);
        this.clients.forEach(ws => {
            if (ws.readyState === WebSocket.OPEN) ws.send(data);
        });
    }
}

module.exports = NebulaWebSocket;
